name: Daily Product Link Validation

on:
  # Run daily at 6 AM UTC (1 AM EST / 10 PM PST)
  schedule:
    - cron: '0 6 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

env:
  ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}

jobs:
  validate-and-fix-products:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run link validation and auto-fix
        id: validate
        continue-on-error: true
        run: node scripts/fix-broken-links.js

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Auto-fix: Convert broken product links to search URLs

          Broken links have been automatically converted to Amazon search URLs
          to maintain affiliate revenue while products are unavailable.

          ðŸ¤– Generated by Daily Product Validation workflow"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Send email notification
        if: steps.validate.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš¨ GoodChristmasIdeas.com - Broken Links Detected"
          to: ${{ secrets.ALERT_EMAIL }}
          from: GoodChristmasIdeas Bot <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Broken product links were detected on GoodChristmasIdeas.com

            The following links have been automatically converted to Amazon search URLs:

            ${{ steps.validate.outputs.report || 'See attached report for details.' }}

            ---
            Review the changes at: https://github.com/${{ github.repository }}/commits/deploy

            This is an automated message from GitHub Actions.
          attachments: broken-links-report.txt

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: broken-links-report
          path: |
            broken-links-report.txt
            broken-links-summary.json
          if-no-files-found: ignore

      - name: Summary
        run: |
          echo "## Product Link Validation Complete" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.validate.outcome }}" == "failure" ]; then
            echo "âš ï¸ Broken links were detected and auto-fixed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Changes have been committed and pushed." >> $GITHUB_STEP_SUMMARY
            if [ -f broken-links-report.txt ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Report" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat broken-links-report.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… All product links are valid!" >> $GITHUB_STEP_SUMMARY
          fi
